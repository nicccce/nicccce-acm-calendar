<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†å½¢é»„æ˜çš„ç®—æ³•ç«èµ›å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            color: white;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .refresh-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .refresh-btn:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .refresh-btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .last-update {
            color: white;
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .filters {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .filter-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 12px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .filter-btn:hover, .filter-btn.active {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
        }

        .contest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
        }

        .contest-card {
            background: white;
            border-radius: 10px;
            padding: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* ç¡®ä¿æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®åœ¨åº•éƒ¨ */
        }

        .contest-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* æ ¹æ®å®é™…çš„platformå­—æ®µå€¼è°ƒæ•´è¿™äº›é€‰æ‹©å™¨ */
        .contest-card.AtCoder { border-left: 4px solid #FF6B6B; }
        .contest-card.Codeforces { border-left: 4px solid #4CAF50; }
        .contest-card.LeetCode { border-left: 4px solid hsl(167, 100%, 54%); }
        .contest-card.NowCoder { border-left: 4px solid #4285F4; }
        .contest-card.Luogu { border-left: 4px solid #FF8C00; }
        .contest-card.æ´›è°· { border-left: 4px solid #FF8C00; }
        .contest-card.ç‰›å®¢ { border-left: 4px solid #4285F4; }

        .platform-tag {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }

        .AtCoder .platform-tag { background: #FF6B6B; }
        .Codeforces .platform-tag { background: #4CAF50; }
        .LeetCode .platform-tag { background: hsl(167, 100%, 54%); }
        .NowCoder .platform-tag { background: #4285F4; }
        .Luogu .platform-tag { background: #FF8C00; }
        .æ´›è°· .platform-tag { background: #FF8C00; }
        .ç‰›å®¢ .platform-tag { background: #4285F4; }

        .contest-name {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            line-height: 1.3;
            display: -webkit-box;
            /* -webkit-line-clamp: 2; */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .contest-info {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .info-item {
            display: flex;
            align-items: flex-start;
            gap: 6px;
            color: #666;
            font-size: 0.8rem;
        }

        .info-icon {
            font-size: 0.9rem;
            min-width: 16px;
        }

        .time-remaining {
            font-weight: bold;
            color: #e74c3c;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .contest-link {
            display: inline-block;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            text-decoration: none;
            padding: 6px 12px;
            border-radius: 20px;
            margin-top: 10px;
            font-weight: bold;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.85rem;
            width: 100%; /* ç¡®ä¿æŒ‰é’®å®½åº¦å æ»¡æ•´ä¸ªå¡ç‰‡ */
            height: 40px; /* å›ºå®šæŒ‰é’®é«˜åº¦ */
        }

        .contest-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .loading {
            text-align: center;
            color: white;
            font-size: 1.1rem;
            padding: 40px;
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-size: 0.9rem;
        }

        .no-contests {
            text-align: center;
            color: white;
            font-size: 1rem;
            padding: 40px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
        }

        .status-upcoming { background-color: #FFA500; }
        .status-running { background-color: #4CAF50; }
        .status-finished { background-color: #666; }

        @media (max-width: 768px) {
            .contest-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 10px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filters {
                justify-content: center;
            }
            
            .contest-card {
                padding: 10px;
            }
        }

        @media (max-width: 480px) {
            .contest-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ† åˆ†å½¢é»„æ˜çš„ç®—æ³•ç«èµ›å¹³å°</h1>
            <p>ä¸€ç«™å¼è·å–è¿‘10æ—¥å„å¤§å¹³å°ç«èµ›ä¿¡æ¯</p>
        </div>

        <div class="controls">
            <button class="refresh-btn" id="refreshBtn">ğŸ”„ åˆ·æ–°ç«èµ›ä¿¡æ¯</button>
            <div class="last-update" id="lastUpdate"></div>
            <div class="filters">
                <button class="filter-btn active" data-platform="all">å…¨éƒ¨</button>
                <button class="filter-btn" data-platform="Codeforces">Codeforces</button>
                <button class="filter-btn" data-platform="LeetCode">LeetCode</button>
                <button class="filter-btn" data-platform="ç‰›å®¢">ç‰›å®¢</button>
                <button class="filter-btn" data-platform="æ´›è°·">æ´›è°·</button>
                <button class="filter-btn" data-platform="AtCoder">AtCoder</button>
            </div>
        </div>

        <div id="contestContainer" class="contest-grid">
            <div class="loading">æ­£åœ¨åŠ è½½ç«èµ›ä¿¡æ¯...</div>
        </div>
    </div>

    <script>
        class ContestAggregator {
            constructor() {
                this.contests = [];
                this.filteredContests = [];
                // platformMap æ˜ å°„ç”¨äºæ˜¾ç¤ºå¹³å°åç§°
                this.platformMap = {};
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadContests();
            }

            bindEvents() {
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadContests();
                });

                // ç»‘å®šç­›é€‰æŒ‰é’®äº‹ä»¶
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        const platform = e.target.dataset.platform;
                        this.filterContests(platform);
                    });
                });
            }

            async loadContests() {
                const refreshBtn = document.getElementById('refreshBtn');
                const contestContainer = document.getElementById('contestContainer');
                
                refreshBtn.disabled = true;
                refreshBtn.textContent = 'ğŸ”„ æ­£åœ¨åŠ è½½...';
                contestContainer.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½ç«èµ›ä¿¡æ¯...</div>';

                try {
                    // ä»æœ¬åœ°JSONæ–‡ä»¶åŠ è½½æ•°æ®
                    const response = await fetch('json/all_contest.json');
                    let allContests = await response.json();
                    
                    // å¤„ç†æ•°æ®æ ¼å¼å¹¶è¿‡æ»¤
                    this.contests = allContests
                        .map(contest => ({
                            ...contest,
                            id: `${contest.platform}-${contest.name}`,
                            startTime: new Date(contest.start_time * 1000).toISOString(),
                            endTime: new Date(contest.end_time * 1000).toISOString(),
                            duration: contest.durationSeconds,
                            url: contest.contest_url.trim(), // å»é™¤URLæœ«å°¾çš„ç©ºæ ¼
                            platform: contest.platform
                        }))
                        .filter(contest => this.isWithinTenDays(contest)); // åªä¿ç•™è¿‘10å¤©çš„ç«èµ›
                    
                    // åŠ¨æ€æ„å»º platformMap
                    this.buildPlatformMap();
                    
                    this.updateLastUpdate();
                    this.filterContests('all');
                } catch (error) {
                    console.error('åŠ è½½ç«èµ›æ•°æ®å¤±è´¥:', error);
                    contestContainer.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                } finally {
                    refreshBtn.disabled = false;
                    refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ç«èµ›ä¿¡æ¯';
                }
            }

            // åŠ¨æ€æ„å»ºå¹³å°æ˜ å°„å…³ç³»
            buildPlatformMap() {
                const platformNames = [...new Set(this.contests.map(c => c.platform))];
                
                // é»˜è®¤æ˜ å°„å…³ç³»ï¼Œä½ å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
                const defaultMap = {
                    'AtCoder': 'AtCoder',
                    'Codeforces': 'Codeforces',
                    'LeetCode': 'LeetCode',
                    'NowCoder': 'ç‰›å®¢',
                    'ç‰›å®¢': 'ç‰›å®¢',
                    'Luogu': 'æ´›è°·',
                    'æ´›è°·': 'æ´›è°·'
                };
                
                // ä¸ºæ¯ä¸ªå¹³å°åˆ›å»ºæ˜ å°„
                platformNames.forEach(platform => {
                    this.platformMap[platform] = defaultMap[platform] || platform;
                });
                
                console.log('å¹³å°æ˜ å°„å…³ç³»:', this.platformMap);
            }

            // åˆ¤æ–­ç«èµ›æ˜¯å¦åœ¨è¿‘10å¤©å†…ï¼ˆåŒ…æ‹¬å³å°†å¼€å§‹å’Œè¿›è¡Œä¸­çš„ç«èµ›ï¼‰
            isWithinTenDays(contest) {
                const now = new Date();
                const start = new Date(contest.startTime);
                const end = new Date(contest.endTime);
                const tenDaysLater = new Date(now.getTime() + 10 * 24 * 60 * 60 * 1000);

                // ç«èµ›åœ¨10å¤©å†…å¼€å§‹ï¼Œæˆ–è€…æ­£åœ¨è¿›è¡Œä¸­ï¼ˆç»“æŸæ—¶é—´åœ¨ç°åœ¨ä¹‹åï¼‰
                return (start >= now && start <= tenDaysLater) || (start <= now && end >= now);
            }

            updateLastUpdate() {
                const now = new Date();
                document.getElementById('lastUpdate').textContent = 
                    `æœ€åæ›´æ–°: ${now.toLocaleString('zh-CN')}`;
            }

            filterContests(platform) {
                if (platform === 'all') {
                    this.filteredContests = [...this.contests];
                } else {
                    this.filteredContests = this.contests.filter(contest => contest.platform === platform);
                }
                this.renderContests();
            }

            renderContests() {
                const container = document.getElementById('contestContainer');
                
                if (this.filteredContests.length === 0) {
                    container.innerHTML = '<div class="no-contests">æš‚æ— ç›¸å…³ç«èµ›ä¿¡æ¯</div>';
                    return;
                }

                // æŒ‰å¼€å§‹æ—¶é—´æ’åº
                this.filteredContests.sort((a, b) => new Date(a.startTime) - new Date(b.startTime));

                container.innerHTML = this.filteredContests.map(contest => {
                    const status = this.getContestStatus(contest);
                    return `
                        <div class="contest-card ${contest.platform}">
                            <div class="platform-tag">${this.platformMap[contest.platform] || contest.platform}</div>
                            <div class="contest-name">${contest.name}</div>
                            <div class="contest-info">
                                <div class="info-item">
                                    <span class="info-icon">â°</span>
                                    <span>${new Date(contest.startTime).toLocaleString('zh-CN', {
                                        month: 'numeric',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}</span>
                                </div>
                                <div class="info-item">
                                    <span class="info-icon">â±ï¸</span>
                                    <span>${this.formatDuration(contest.duration)}</span>
                                </div>
                                <div class="info-item">
                                    <span class="status-indicator status-${status.type}"></span>
                                    <span>${status.text}</span>
                                </div>
                                <div class="time-remaining" id="timer-${this.escapeId(contest.id)}">
                                    ${this.getTimeRemaining(contest.startTime, contest.endTime)}
                                </div>
                                <a href="${contest.url}" target="_blank" class="contest-link">æŸ¥çœ‹è¯¦æƒ…</a>
                            </div>
                        </div>
                    `;
                }).join('');

                // å¯åŠ¨å€’è®¡æ—¶æ›´æ–°
                this.startTimers();
            }

            escapeId(id) {
                return id.replace(/[^a-zA-Z0-9]/g, '_');
            }

            getContestStatus(contest) {
                const now = new Date();
                const start = new Date(contest.startTime);
                const end = new Date(contest.endTime);

                if (now < start) {
                    return { type: 'upcoming', text: 'å³å°†å¼€å§‹' };
                } else if (now > end) {
                    return { type: 'finished', text: 'å·²ç»“æŸ' };
                } else {
                    return { type: 'running', text: 'è¿›è¡Œä¸­' };
                }
            }

            startTimers() {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                }

                this.timerInterval = setInterval(() => {
                    this.filteredContests.forEach(contest => {
                        const timerElement = document.getElementById(`timer-${this.escapeId(contest.id)}`);
                        if (timerElement) {
                            timerElement.innerHTML = this.getTimeRemaining(contest.startTime, contest.endTime);
                        }
                    });
                }, 1000);
            }

            getTimeRemaining(startTime, endTime) {
                const now = new Date();
                const start = new Date(startTime);
                const end = new Date(endTime);

                if (now < start) {
                    // ç«èµ›æœªå¼€å§‹
                    const diff = start - now;
                    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    if (days > 0) {
                        return `â³ ${days}å¤©${hours}å°æ—¶å`;
                    } else if (hours > 0) {
                        return `â³ ${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
                    } else {
                        return `â³ ${minutes}åˆ†${seconds}ç§’`;
                    }
                } else if (now > end) {
                    // ç«èµ›å·²ç»“æŸ
                    return '<span style="color: #666;">ğŸ å·²ç»“æŸ</span>';
                } else {
                    // ç«èµ›è¿›è¡Œä¸­
                    const diff = end - now;
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);

                    if (hours > 0) {
                        return `ğŸš€ å‰©ä½™${hours}å°æ—¶`;
                    } else {
                        return `ğŸš€ å‰©ä½™${minutes}åˆ†${seconds}ç§’`;
                    }
                }
            }

            formatDuration(seconds) {
                if (!seconds) return 'æœªçŸ¥';
                
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                
                if (hours > 0) {
                    return `${hours}å°æ—¶${minutes > 0 ? `${minutes}åˆ†é’Ÿ` : ''}`;
                } else {
                    return `${minutes}åˆ†é’Ÿ`;
                }
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new ContestAggregator();
        });

        // æ·»åŠ é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
        window.addEventListener('error', (e) => {
            console.error('åº”ç”¨é”™è¯¯:', e.error);
        });
    </script>
</body>
</html>